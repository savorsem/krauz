/**\n * @license\n * SPDX-License-Identifier: Apache-2.0\n*/\n\nimport { GoogleGenAI } from '@google/genai';\nimport { GenerateVideoParams, GenerationMode } from '../types';\nimport { getApiKeys, validateApiKey } from '../utils/envUtils';\n\nexport const generateVideo = async (\n  params: GenerateVideoParams,\n): Promise<{url: string; blob: Blob}> => {\n  console.log('[Veo Service] Starting generation...', params.mode);\n\n  const apiKeys = getApiKeys();\n  const geminiKey = apiKeys.gemini;\n  \n  if (!geminiKey) {\n    throw new Error('Gemini API Key is missing. Please configure your API key in the application settings.');\n  }\n  \n  // Validate the API key format\n  const validation = validateApiKey(geminiKey, 'gemini');\n  if (!validation.valid) {\n    throw new Error(`Invalid Gemini API Key: ${validation.error}`);\n  }\n\n  const ai = new GoogleGenAI({apiKey: geminiKey});\n\n  const generateVideoPayload: any = {\n    model: params.model,\n    prompt: params.prompt,\n    config: {\n      numberOfVideos: 1,\n      aspectRatio: params.aspectRatio,\n      resolution: params.resolution,\n    },\n  };\n\n  try {\n    if (params.mode === GenerationMode.FRAMES_TO_VIDEO) {\n      if (params.startFrame) {\n        generateVideoPayload.image = {\n          imageBytes: params.startFrame.base64,\n          mimeType: params.startFrame.file.type,\n        };\n      }\n      \n      const finalEndFrame = params.isLooping ? params.startFrame : params.endFrame;\n      if (finalEndFrame) {\n        generateVideoPayload.config.lastFrame = {\n          imageBytes: finalEndFrame.base64,\n          mimeType: finalEndFrame.file.type,\n        };\n      }\n    } else if (params.mode === GenerationMode.REFERENCES_TO_VIDEO) {\n      const referenceImagesPayload: any[] = [];\n\n      if (params.referenceImages) {\n        for (const img of params.referenceImages) {\n          referenceImagesPayload.push({\n            image: {\n              imageBytes: img.base64,\n              mimeType: img.file.type,\n            },\n          });\n        }\n      }\n\n      if (params.styleImage) {\n        referenceImagesPayload.push({\n          image: {\n            imageBytes: params.styleImage.base64,\n            mimeType: params.styleImage.file.type,\n          },\n        });\n      }\n\n      if (referenceImagesPayload.length > 0) {\n        generateVideoPayload.config.referenceImages = referenceImagesPayload;\n        // Cameo mode requires Veo Pro\n        generateVideoPayload.model = 'veo-3.1-generate-preview';\n      }\n    }\n\n    // STRICT CONSTRAINT ENFORCEMENT for Veo Pro\n    if (generateVideoPayload.model === 'veo-3.1-generate-preview') {\n        console.log('[Veo Service] Auto-correcting config for Veo Pro: 16:9, 720p');\n        generateVideoPayload.config.aspectRatio = '16:9';\n        generateVideoPayload.config.resolution = '720p';\n    }\n\n  } catch (payloadError) {\n    console.error(\"Error building payload:\", payloadError);\n    throw new Error(\"Failed to prepare request data.\");\n  }\n\n  let operation;\n  try {\n      console.log('[Veo Service] Payload:', JSON.stringify(generateVideoPayload, null, 2));\n      operation = await ai.models.generateVideos(generateVideoPayload);\n      console.log('[Veo Service] Operation started:', operation.name);\n  } catch (e: any) {\n      console.error('[Veo Service] API Request Failed:', e);\n      let msg = e.message || String(e);\n\n      // Detect Quota/Billing issues\n     if (msg.includes('429') || msg.toLowerCase().includes('quota')) {\n          msg = 'Quota exceeded. Please check your billing details.';\n      } else if (msg.includes('403') || msg.toLowerCase().includes('permission')) {\n          msg = 'API Key invalid or billing disabled.';\n      }\n      throw new Error(msg);\n  }\n\n  const startTime = Date.now();\n  const TIMEOUT_MS = 600000;\n  const POLLING_INTERVAL = 5000;\n\n  while (!operation.done) {\n    if (Date.now() - startTime > TIMEOUT_MS) {\n       throw new Error(\"Generation timed out.\");\n    }\n    \n    await new Promise((resolve) => setTimeout(resolve, POLLING_INTERVAL));\n    \n    try {\n        operation = await ai.operations.getVideoOperation({operation: operation});\n    } catch (pollError) {\n        console.warn('[Veo Service] Polling network error, retrying...', pollError);\n    }\n  }\n\n  if (operation.error) {\n    console.error('[Veo Service] Backend Error:', operation.error);\n    throw new Error(operation.error.message || 'Model refused request.');\n  }\n\n  const response = operation.response || (operation as any).result;\n  const generatedVideos = response?.generatedVideos;\n\n  if (generatedVideos?.length > 0) {\n    const videoUri = generatedVideos[0].video?.uri;\n    if (!videoUri) throw new Error('API returned success but no video URI.');\n\n    try {\n        const cleanUri = decodeURIComponent(videoUri);\n        const fetchUrl = `${cleanUri}&key=${process.env.API_KEY}`;\n        \n        console.log('[Veo Service] Downloading video...');\n        const res = await fetch(fetchUrl);\n        \n        if (!res.ok) throw new Error(`Download failed: ${res.status}`);\n        \n        const blob = await res.blob();\n        const url = URL.createObjectURL(blob);\n        \n        return { url, blob };\n    } catch (downloadError: any) {\n        console.error(\"Download error:\", downloadError);\n        throw new Error(`Failed to download video: ${downloadError.message}`);\n    }\n  } else {\n    // Handle RAI Filtering (Safety Block)\n    if (response?.raiMediaFilteredReasons && response.raiMediaFilteredReasons.length > 0) {\n      const reason = response.raiMediaFilteredReasons[0];\n      console.error('[Veo Service] RAI Filtered:', reason);\n      throw new Error(`Content was filtered for safety reasons: ${reason}`);\n    }\n\n    console.error('[Veo Service] Empty response:', JSON.stringify(operation, null, 2));\n    throw new Error('Empty response. Please check your prompt and try again, or ensure you have access to the selected model (Veo Pro requires 16:9/720p).');\n  }\n};