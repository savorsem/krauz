LyoqCiAqIEBsaWNlbnNlCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBB\ncGFjaGUtMi4wCiovCmltcG9ydCB7CiAgR29vZ2xlR2VuQUksCiAgVmlkZW9H\nZW5lcmF0aW9uUmVmZXJlbmNlSW1hZ2UsCiAgVmlkZW9HZW5lcmF0aW9uUmVm\nZXJlbmNlVHlwZSwKfSBmcm9tICdAZ29vZ2xlL2dlbmFpJzsKaW1wb3J0IHtH\nZW5lcmF0ZVZpZGVvUGFyYW1zLCBHZW5lcmF0aW9uTW9kZX0gZnJvbSAnLi4v\ndHlwZXMnOwppbXBvcnQgeyBnZXRBcGlLZXlzLCB2YWxpZGF0ZUFwaUtleSB9\nZnJvbSAnLi4vdXRpbHMvZW52VXRpbHMnOwoKZXhwb3J0IGNvbnN0IGdlbmVy\nYXRlVmlkZW8gPSBhc3luYyAoCiAgcGFyYW1zOiBHZW5lcmF0ZVZpZGVvUGFy\nYW1zLAp9KTogUHJvbWlzZTx7dXJsOiBzdHJpbmc7IGJsb2I6IEJsb2J9PiA9\nPiB7CiAgY29uc29sZS5sb2coJ1tWZW8gU2VydmljZV0gU3RhcnRpbmcgZ2Vu\nZXJhdGlvbi4uLicsIHBhcmFtcy5tb2RlKTsKCiAgY29uc3QgYXBpS2V5cyA9\nIGdldEFwaUtleXMoKTsKICBjb25zdCBnZW1pbmlLZXkgPSBhcGlLZXlzLmdl\nbWluaTsKICAKICBpZiAoIWdlbWluaUtleSkgewogICAgdGhyb3cgbmV3IEVy\ncm9yKCdHZW1pbmkgQVBJIEtleSBpcyBtaXNzaW5nLiBQbGVhc2UgY29uZmln\ndXJlIHlvdXIgQVBJIGtleSBpbiB0aGUgYXBwbGljYXRpb24gc2V0dGluZ3Mu\nJyk7CiAgfQogIAogIC8vIFZhbGlkYXRlIHRoZSBBUEkga2V5IGZvcm1hdAog\nY29uc3QgdmFsaWRhdGlvbiA9IHZhbGlkYXRlQXBpS2V5KGdlbWluaUtleSwg\nJ2dlbWluaScpOwogIGlmICghdmFsaWRhdGlvbi52YWxpZCkgewogICAgdGhy\nb3cgbmV3IEVycm9yKGBJbnZhbGlkIEdlbWluaSBBUEkgS2V5OiAke3Zh\nbGlkYXRpb24uZXJyb3J9YCk7CiAgfQoKICBjb25zdCBhaSA9IG5ldyBHb29n\nbGVHZW5BSSh7YXBpS2V5OiBnZW1pbmlLZXl9KTsKCiAgY29uc3QgZ2VuZXJh\ndGVWaWRlb1BheWxvYWQ6IGFueSA9IHsKICAgIG1vZGVsOiBwYXJhbXMubW9k\nbW9kZWw6IHBhcmFtcy5tb2RlbCwKICAgIHByb21wdDogcGFyYW1zLnBy\nb21wdCwKICAgIGNvbmZpZzogewogICAgICBudW1iZXJPZlZpZGVvczogMSwK\nICAgICAgYXNwZWN0UmF0aW86IHBhcmFtcy5hc3BlY3RSYXRpbywKICAgICAg\ncmVzb2x1dGlvbjogcGFyYW1zLnJlc29sdXRpb24sCiAgICB9LAogIH07Cgog\ndHJ5IHsKICAgIGlmIChwYXJhbXMubW9kZSA9PT0gR2VuZXJhdGlvbk1vZGUu\nRlJBTUVTX1RPX1ZJREVPKSB7CiAgICAgIGlmIChwYXJhbXMuc3RhcnRGcmFt\nZSkgewogICAgICAgIGdlbmVyYXRlVmlkZW9QYXlsb2FkLmltYWdlID0gewog\nICAgICAgICAgIGltYWdlQnl0ZXM6IHBhcmFtcy5zdGFydEZyYW1lLmJh\nc2U2NCwKICAgICAgICAgIG1pbWVUeXBlOiBwYXJhbXMuc3RhcnRGcmFtZS5m\naWxlLnR5cGUsCiAgICAgICAgfTsKICAgICAgfQogICAgICAKICAgICAg\nY29uc3QgZmluYWxFbmRGcmFtZSA9IHBhcmFtcy5pc0xvb3BpbmcgPyBwYXJh\nbXMuc3RhcnRGcmFtZSA6IHBhcmFtcy5lbmRGcmFtZTsKICAgICAgaWYgKGZp\nbmFsRW5kRnJhbWUpIHsKICAgICAgICBnZW5lcmF0ZVZpZGVvUGF5bG9hZC5j\nb25maWcubGFzdEZyYW1lID0gewogICAgICAgICAgaW1hZ2VCeXRlczogZmlu\nYWxFbmRGcmFtZS5iYXNlNjQsCiAgICAgICAgICBtaW1lVHlwZTogZmluYWxF\nbmRGcmFtZS5maWxlLnR5cGUsCiAgICAgICAgfTsKICAgICAgfQogICAg\nfSBlbHNlIGlmIChwYXJhbXMubW9kZSA9PT0gR2VuZXJhdGlvbk1vZGUuUkVG\nRVJFTkNFU19UT19WSURFTykgewogICAgICBjb25zdCByZWZlcmVuY2VJbWFn\nZXNQYXlsb2FkOiBWaWRlb0dlbmVyYXRpb25SZWZlcmVuY2VJbWFnZVtdID0g\nW107CgogICAgICBpZiAocGFyYW1zLnJlZmVyZW5jZUltYWdlcykgewogICAg\nICAgIGZvciAoY29uc3QgaW1nIG9mIHBhcmFtcy5yZWZlcmVuY2VJbWFnZXMp\nIHsKICAgICAgICAgIHJlZmVyZW5jZUltYWdlc1BheWxvYWQucHVzaCh7CiAg\nICAgICAgICAgIGltYWdlOiB7CiAgICAgICAgICAgICAgaW1hZ2VCeXRlczog\naW1nLmJhc2U2NCwKICAgICAgICAgICAgICBtaW1lVHlwZTogaW1nLmZpbGUu\ndHlwZSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVmZXJlbmNl\nVHlwZTogVmlkZW9HZW5lcmF0aW9uUmVmZXJlbmNlVHlwZS5BU1NFVCwKICAg\nICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAocGFyYW1z\nLnN0eWxlSW1hZ2UpIHsKICAgICAgICByZWZlcmVuY2VJbWFnZXNQYXlsb2Fk\nLnB1c2goewogICAgICAgICAgaW1hZ2U6IHsKICAgICAgICAgICAgaW1hZ2VC\neXRlczogcGFyYW1zLnN0eWxlSW1hZ2UuYmFzZTY0LAogICAgICAgICAgICBt\naW1lVHlwZTogcGFyYW1zLnN0eWxlSW1hZ2UuZmlsZS50eXBlLAogICAgICAg\nIH0sCiAgICAgICAgICByZWZlcmVuY2VUeXBlOiBWaWRlb0dlbmVyYXRpb25S\nZWZlcmVuY2VUeXBlLlNUWUxFLAogICAgICAgIH0pOwogICAgICB9CgogICAg\nICBpZiAocmVmZXJlbmNlSW1hZ2VzUGF5bG9hZC5sZW5ndGggPiAwKSB7CiAg\nICAgICAgZ2VuZXJhdGVWaWRlb1BheWxvYWQuY29uZmlnLnJlZmVyZW5jZUlt\nYWdlcyA9IHJlZmVyZW5jZUltYWdlc1BheWxvYWQ7CiAgICAgICAgLy8gQ2Ft\nZW8gbW9kZSByZXF1aXJlcyBWZW8gUHJvCiAgICAgICAgZ2VuZXJhdGVWaWRl\nb1BheWxvYWQubW9kZWwgPSAndmVvLTMuMS1nZW5lcmF0ZS1wcmV2aWV3JzsK\nICAgICAgfQogICAgfQoKICAgIC8vIFNUUklDVCBDT05TVFJBSU5UIEVORk9S\nQ0VNRU5UIGZvciBWZW8gUHJvCiAgICBpZiAoZ2VuZXJhdGVWaWRlb1BheWxv\nYWQubW9kZWwgPT09ICd2ZW8tMy4xLWdlbmVyYXRlLXByZXZpZXcnKSB7CiAg\nICAgICAgY29uc29sZS5sb2coJ1tWZW8gU2VydmljZV0gQXV0by1jb3JyZWN0\naW5nIGNvbmZpZyBmb3IgVmVvIFBybzogMTY6OSwgNzIwcCcpOwogICAgICAg\nIGdlbmVyYXRlVmlkZW9QYXlsb2FkLmNvbmZpZy5hc3BlY3RSYXRpbyA9ICcx\nNjo5JzsKICAgICAgICBnZW5lcmF0ZVZpZGVvUGF5bG9hZC5jb25maWcucmVz\nb2x1dGlvbiA9ICc3MjBwJzsKICAgIH0KCiAgfSBjYXRjaCAocGF5bG9hZEVy\ncm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvciBidWlsZGluZyBwYXls\nb2FkOiIsIHBheWxvYWRFcnJvcik7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkZh\naWxlZCB0byBwcmVwYXJlIHJlcXVlc3QgZGF0YS4iKTsKICB9CgogIGxldCBv\ncGVyYXRpb247CiAgdHJ5IHsKICAgICAgY29uc29sZS5sb2coJ1tWZW8gU2Vy\ndmljZV0gUGF5bG9hZDonLCBKU09OLnN0cmluZ2lmeShnZW5lcmF0ZVZpZGVv\nUGF5bG9hZCwgbnVsbCwgMikpOwogICAgICBvcGVyYXRpb24gPSBhd2FpdCBh\naS5tb2RlbHMuZ2VuZXJhdGVWaWRlb3MoZ2VuZXJhdGVWaWRlb1BheWxvYWQp\nOwogICAgICBjb25zb2xlLmxvZygnW1ZlbyBTZXJ2aWNlXSBPcGVyYXRpb24g\nc3RhcnRlZDonLCBvcGVyYXRpb24ubmFtZSk7CiAgfSBjYXRjaCAoZTogYW55\nKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoJ1tWZW8gU2VydmljZV0gQVBJIFJl\ncXVlc3QgRmFpbGVkOicsIGUpOwogICAgICBsZXQgbXNnID0gZS5tZXNzYWdl\nIHx8IFN0cmluZyhlKTsKCiAgICAgIC8vIERldGVjdCBRdW90YS9CaWxsaW5n\nIGlzc3VlcwogICAgIGlmIChtc2cuaW5jbHVkZXMoJzQyOScpIHx8IG1zZy50\nb0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCd1b3RhJykpIHsKICAgICAgICAgIG1z\nZyA9ICdRdW90YSBleGNlZWRlZC4gUGxlYXNlIGNoZWNrIHlvdXIgYmlsbGluZy\nZGV0YWlscy4nOwogICAgICB9IGVsc2UgaWYgKCBtc2cuaW5jbHVkZXMoJzQw\nMycpIHx8IG1zZy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdwZXJtaXNzaW9u\nJykpIHsKICAgICAgICAgIG1zZyA9ICdBUEkgS2V5IGludmFsaWQgb3IgYmls\nbGluZyBkaXNhYmxlZC4nOwogICAgICB9CiAgICAgIHRocm93IG5ldyBFcnJv\ncihtc2cpOwogIH0KCiAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTsK\nICBjb25zdCBUSU1FT1VUX01TID0gNjAwMDAwOwogIGNvbnN0IFBPTExJTkdf\nSU5URVJWQUwgPSA1MDAwOwoKICB3aGlsZSAoIW9wZXJhdGlvbi5kb25lKSB7\nCiAgICBpZiAoRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSA+IFRJTUVPVVRfTVMp\nIHsKICAgICAgIHRocm93IG5ldyBFcnJvcigiR2VuZXJhdGlvbiB0aW1lZCBv\ndXQuIik7CiAgICB9CiAgICAKICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNv\nbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIFBPTExJTkdfSU5URVJWQUwp\nKTsKICAgIAogICAgdHJ5IHsKICAgICAgICBvcGVyYXRpb24gPSBhd2FpdCBh\naS5vcGVyYXRpb25zLmdldFZJZGVvc09wZXJhdGlvbih7b3BlcmF0aW9uOiBv\ncGVyYXRpb259KTsKICAgIH0gY2F0Y2ggKHBvbGxFcnJvcikge1xuICAgICAgICBjb25zb2xlLndhcm4oJ1tWZW8gU2VydmljZV0gUG9sbGluZyBu\nZXR3b3JrIGVycm9yLCByZXRyeWluZy4uLicsIHBvbGxFcnJvcik7CiAgICB9\nCiAgfQoKICBpZiAob3BlcmF0aW9uLmVycm9yKSB7CiAgICBjb25zb2xlLmVy\ncm9yKCdbVmVvIFNlcnZpY2VdIEJhY2tlbmQgRXJyb3I6Jywgb3BlcmF0aW9u\nLmVycm9yKTsKICAgIHRocm93IG5ldyBFcnJvcihvcGVyYXRpb24uZXJyb3Iu\nbWVzc2FnZSB8fCAnTW9kZWwgcmVmdXNlZCByZXF1ZXN0LicpOwogIH0KCiAg\nY29uc3QgcmVzcG9uc2UgPSBvcGVyYXRpb24ucmVzcG9uc2UgfHwgKG9wZXJhdGlv\biBhcyBhbnkpLnJlc3VsdDsKICBjb25zdCBnZW5lcmF0ZWRWaWRlb3MgPSBy\nZXNwb25zZT8uZ2VuZXJhdGVkVmlkZW9zOwoKICBpZiAoZ2VuZXJhdGVkVmlk\nZW9zPy5sZW5ndGggPiAwKSB7CiAgICBjb25zdCB2aWRlb1VyaSA9IGdlbmVy\nYXRlZFZpZGVvc1swXS52aWRlbz8udXJpOwogICAgaWYgKCF2aWRlb1VyaSkg\ndGhyb3cgbmV3IEVycm9yKCdBUEkgcmV0dXJuZWQgc3VjY2VzcyBidXQgbm8g\ndmlkZW8gVVJJLicpOwoKICAgIHRyeSB7CiAgICAgICAgY29uc3QgY2xl\nYW5VcmkgPSBkZWNvZGVVUklDb21wb25lbnQodmlkZW9VcmkpOwogICAgICAg\nIGNvbnN0IGZldGNoVXJsID0gYCR7Y2xlYW5Vcml9JmtleT0ke3Byb2Nlc3Mu\nZW52LkFQSV9LRVl9YDsKICAgICAgICAKICAgICAgICBjb25zb2xlLmxvZygn\nW1ZlbyBTZXJ2aWNlXSBEb3dubG9hZGluZyB2aWRlby4uLicpOwogICAgICAg\nIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGZldGNoVXJsKTsKICAgICAgICAK\nICAgICAgICBpZiAoIXJlcy5vaykgdGhyb3cgbmV3IEVycm9yKGBEb3dubG9h\nZCBmYWlsZWQ6ICR7cmVzLnN0YXR1c31gKTsKICAgICAgICAKICAgICAgICBj\nb25zdCBibG9iID0gYXdhaXQgcmVzLmJsb2IoKTsKICAgICAgICBjb25zdCB1\ncmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICAgIAog\nICAgICAgcmV0dXJuIHsgdXJsLCBibG9iIH07CiAgICB9IGNhdGNoIChkb3du\nbG9hZEVycm9yOiBhbnkpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJEb3du\nbG9hZCBlcnJvcjoiLCBkb3dubG9hZEVycm9yKTsKICAgICAgICB0aHJvdyBu\ ZXcgRXJyb3IoYEZhaWxlZCB0byBkb3dubG9hZCB2aWRlbzogJHtkb3dubG9h\nZEVycm9yLm1lc3NhZ2V9YCk7CiAgICB9CiAgfSBlbHNlIHsKICAgIC8vIEhh\nbmRsZSBSQUkgRmlsdGVyaW5nIChTYWZldHkgQmxvY2spCiAgICBpZiAocmVz\ncG9uc2U/LnJhaU1lZGlhRmlsdGVyZWRSZWFzb25zICYmIHJlc3BvbnNlLnJh\aU1lZGlhRmlsdGVyZWRSZWFzb25zLmxlbmd0aCA+IDApIHsKICAgICAg\ Y29uc3QgcmVhc29uID0gcmVzcG9uc2UucmFpTWVkaWFGaWx0ZXJlZFJlYXNv\bnNbMF07CiAgICAgIGNvbnNvbGUuZXJyb3IoJ1tWZW8gU2VydmljZV0g\ UkFJIEZpbHRlcmVkOicsIHJlYXNvbik7CiAgICAgIHRocm93IG5ldyBFcnJv\ckMoL9CS0LjQtNC10L4g0LfQsNCx0LvQvtC60LjRgNC+0LLQsNC90L4g\n0YTQuNC70YzRgtGA0L7QvCDQsdC10LfQvtC/0LDRgdC90L7RgdGC0Lg6\nICR7cmVhc29ufWApOwogICAgfQoKICAgIGNvbnNvbGUuZXJyb3IoJ1tW\ ZW8gU2VydmljZV0gRW1wdHkgcmVzcG9uc2U6JywgSlNPTi5zdHJpbmdpZnko\nb3BlcmF0aW9uLCBudWxsLCAyKSk7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ9CS\n0LjQtNC10L4g0L3QtSDRgdC+0LfQtNCw0L3Qvi4g0JLQvtC30LzQvtC20L3Q\nviwg0YHRgNCw0LHQvtGC0LDQu9C4INGE0LjQu9GM0YLRgNGLINCx0LXQt9C+\n0L/QsNGB0L3QvtGB0YLQuCDQuNC70Lgg0L3QtdCy0LXRgNC90LDRjyDQu9C+\n0L3RhNC40LPRg9GA0LDRhtC40Y8gKNC00LvRjyBQcm8g0YLRgNC10LHRg9C1\n0YLRgdGPIDE2OjkvNzIwcCkuJyk7CiAgfQp9Ow==\n"